@using HomeEntertainmentAdvisor.Models;
@using HomeEntertainmentAdvisor.Services.Interfaces;
@inject IReviewService reviewService
@inject ISnackbar snackBar

<MudTable Items="@Reviews" Filter="new Func<Review,bool>(FilterFunc1)" Hover="true" Bordered="true" Striped="false">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Your reviews</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>№</MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Review, object>(x=>x.Name)">
                Name
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Review, object>(x=>x.CachedLikes)">
                Likes
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Review, object>(x=>x.Status)">
                Status
            </MudTableSortLabel>
        </MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="№">@Reviews.IndexOf(context)</MudTd>
        <MudTd DataLabel="Name">
            <MudLink Href="@GetHref(context)">
                @context.Name
            </MudLink>
        </MudTd>
        <MudTd DataLabel="Likes">@context.CachedLikes</MudTd>
        <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.RemoveRedEye" Color="Color.Surface" Href="@GetHref(context)" />
            <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Edit" Color="Color.Surface" Href="@GetEditHref(context)" />
            <MudIconButton Size="Size.Small" OnClick="()=>HandleDeleteReviewClicked(context)" Icon="@GetDeleteIconButton(context)" Color="Color.Surface" />
        </MudTd>
    </RowTemplate>
</MudTable>
@code {
    [Parameter]
    public List<Review> Reviews { get; set; } = new();
    private string searchString1 = "";

    private string GetDeleteIconButton(Review context)
    {
        if (context.Status == ReviewStatus.Deleted) return Icons.Material.Filled.Restore;
        return Icons.Material.Filled.Delete;
    }

    private string GetHref(Review context)
    {
        return $"Review/{context.Id}";
    }
    private string GetEditHref(Review context)
    {
        return $"Review/Edit/{context.Id}";
    }
    private async Task HandleDeleteReviewClicked(Review review)
    {
        if (review.Status != ReviewStatus.Deleted)
        {
            await reviewService.SetStatus(review, ReviewStatus.Deleted);
            snackBar.Add($"{review.Name} deleted!");
        }
        else
        {
            await reviewService.SetStatus(review, ReviewStatus.Draft);
            snackBar.Add($"{review.Name} restored!");
        }
    }

    private bool FilterFunc1(Review review) => FilterFunc(review, searchString1);

    private bool FilterFunc(Review review, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (review.Name.StartsWith(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

}
