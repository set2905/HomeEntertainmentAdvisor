@page "/Review/{ReviewId}"
@using HomeEntertainmentAdvisor.Models;
@using HomeEntertainmentAdvisor.Services.Interfaces;
@using Markdig.Syntax.Inlines;
@inject IReviewService reviewService
@inject IMediaService mediaService
@inject IRatingService ratingService
@inject IReviewLikeService likeService
@inject ISnackbar snackBar
<PageTitle>Review</PageTitle>
<MudText>
    @review.Name
</MudText>
<MudMarkdown Value="@review.Content"
             Styling="Styling"
             TableCellMinWidth="100"
             CodeBlockTheme="CodeBlockTheme.DraculaBase16" />
<MudText>
    @likeCount
</MudText>
<MudIconButton Icon="@Icons.Material.Filled.ThumbUp" Color="@likeButtonColor" OnClick="HandleLikeClicked" />
@code
{
    [Parameter]
    public string? ReviewId { get; set; }
    private Review review = new();
    private int likeCount;
    private Color likeButtonColor = Color.Surface;
    private bool liked = false;

    private MudMarkdownStyling Styling { get; } = new();
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await SetReview();
    }
    private async Task HandleLikeClicked()
    {
        if (!liked)
        {
            likeButtonColor = Color.Success;
            StateHasChanged();
            if (!await likeService.LikeReview(review.Id))
                snackBar.Add("Like couldnt be added");
        }
        else
        {
            likeButtonColor = Color.Surface;
            StateHasChanged();
            if (!await likeService.RemoveLikeReview(review.Id))
                snackBar.Add("Like couldnt be removed");
        }
        await SetLikes();
    }
    private async Task SetLikes()
    {
        if (await likeService.IsLikedByUser(review))
        {
            liked = true;
            likeButtonColor = Color.Success;
        }
        else
        {
            liked = false;
            likeButtonColor = Color.Surface;
        }
        likeCount = await likeService.UpdateLikeCount(review);
        StateHasChanged();
    }
    private async Task SetReview()
    {
        if (ReviewId!=null)
        {
            Guid reviewGuid;
            if (Guid.TryParse(ReviewId, out reviewGuid))
            {
                Review? found = await reviewService.GetById(reviewGuid);
                if (found == null)
                {
                    snackBar.Add("Review not found!", Severity.Error);
                    return;
                }
                Rating? rating = await ratingService.GetById(found.RatingId);
                if (rating == null)
                {
                    snackBar.Add("Rating not found!", Severity.Error);
                    return;
                }
                found.Rating = rating;
                review = found;
                await SetLikes();
            }
        }
    }
}