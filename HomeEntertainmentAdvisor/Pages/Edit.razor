@page "/EditReview"
@using Blazored.FluentValidation
@using HomeEntertainmentAdvisor.Models;
@using HomeEntertainmentAdvisor.Services.Interfaces;
@using Markdig.Syntax.Inlines;
@inject IReviewService reviewService
@inject IMediaService mediaService
@inject IRatingService ratingService
<PageTitle>Edit review</PageTitle>

<EditForm Model="@review" OnValidSubmit="@SubmitValidForm">
    <FluentValidationValidator />
    <ValidationSummary />
    <MudAutocomplete T="MediaPiece" Label="Media" @bind-Value="review.Rating.MediaPiece" SearchFuncWithCancel="@SearchMediaPieces"
                     ToStringFunc="@(e=> e!=null?e.Name:null)" Immediate="true"
                     AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" ShowProgressIndicator="true">
        <ProgressIndicatorTemplate>
            <MudProgressLinear Size="Size.Small" Indeterminate="true" />
        </ProgressIndicatorTemplate>
    </MudAutocomplete>

    <MudText>Name: </MudText>
    <MudTextField @bind-Value="@review.Name" />
    <MudText>Content: </MudText>
    <MarkdownEditor @bind-Value="@review.Content"
                    />

    <MudRating @bind-SelectedValue="@review.Rating.Grade" MaxValue="10" />

    <MudButton ButtonType="ButtonType.Submit">Save</MudButton>
</EditForm>

@code
{
    private MudMarkdownStyling Styling { get; } = new();
    private Review review = new();
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

    }
    private async Task<IEnumerable<MediaPiece>> SearchMediaPieces(string value, CancellationToken token)
    {
        IEnumerable<MediaPiece> result = await mediaService.Search(value, token);
        return result;
    }



    private async Task SubmitValidForm()
    {
        Console.WriteLine("Form submitted");
        review.RatingId = await ratingService.SaveRating(review.Rating);
        Guid reviewId = await reviewService.SaveReview(review);
    }
    private Typo OverrideHeaderTypo(Typo x)
    {
        return x == Typo.h1 ? Typo.h4 : x;
    }

    private static string? OverrideLink(LinkInline x)
    {
        return x.Url;
    }
}